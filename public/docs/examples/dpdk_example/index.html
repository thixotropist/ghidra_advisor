<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">


<link rel="shortcut icon" href="/ghidra_advisor/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/ghidra_advisor/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/ghidra_advisor/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/ghidra_advisor/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/ghidra_advisor/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/ghidra_advisor/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/ghidra_advisor/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/ghidra_advisor/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/ghidra_advisor/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/ghidra_advisor/favicons/android-192x192.png" sizes="192x192">

<title>DPDK Network Example | Ghidra Advisor for RISCV-64 Vector Extensions</title>
<meta name="description" content="Are network appliances improved with autovectorization? We can examine code examples taken from the DPDK network project to find out. We&rsquo;ll start with code that uses vector gather and slide operations in what might be a key datapath routine. The binary dpdk_l3fwd is an example of a layer 3 forwarding engine. It includes the function rx_recv_pkts, which appears to be selected from the DPDK source file drivers/net/iavf/iavf_rxtx.c.
This function includes several vector stanzas that use vrgather and vslide1down.">
<meta property="og:url" content="https://thixotropist.github.io/ghidra_advisor/docs/examples/dpdk_example/">
  <meta property="og:site_name" content="Ghidra Advisor for RISCV-64 Vector Extensions">
  <meta property="og:title" content="DPDK Network Example">
  <meta property="og:description" content="Are network appliances improved with autovectorization? We can examine code examples taken from the DPDK network project to find out. We’ll start with code that uses vector gather and slide operations in what might be a key datapath routine. The binary dpdk_l3fwd is an example of a layer 3 forwarding engine. It includes the function rx_recv_pkts, which appears to be selected from the DPDK source file drivers/net/iavf/iavf_rxtx.c.
This function includes several vector stanzas that use vrgather and vslide1down.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
    <meta property="article:modified_time" content="2024-11-02T15:00:04-04:00">

  <meta itemprop="name" content="DPDK Network Example">
  <meta itemprop="description" content="Are network appliances improved with autovectorization? We can examine code examples taken from the DPDK network project to find out. We’ll start with code that uses vector gather and slide operations in what might be a key datapath routine. The binary dpdk_l3fwd is an example of a layer 3 forwarding engine. It includes the function rx_recv_pkts, which appears to be selected from the DPDK source file drivers/net/iavf/iavf_rxtx.c.
This function includes several vector stanzas that use vrgather and vslide1down.">
  <meta itemprop="dateModified" content="2024-11-02T15:00:04-04:00">
  <meta itemprop="wordCount" content="1977">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="DPDK Network Example">
  <meta name="twitter:description" content="Are network appliances improved with autovectorization? We can examine code examples taken from the DPDK network project to find out. We’ll start with code that uses vector gather and slide operations in what might be a key datapath routine. The binary dpdk_l3fwd is an example of a layer 3 forwarding engine. It includes the function rx_recv_pkts, which appears to be selected from the DPDK source file drivers/net/iavf/iavf_rxtx.c.
This function includes several vector stanzas that use vrgather and vslide1down.">




<link rel="preload" href="/ghidra_advisor/scss/main.min.566d7ac1e84fdb8192a82cf733a3d350d86778608b7404836e1cd5c1232ef742.css" as="style">
<link href="/ghidra_advisor/scss/main.min.566d7ac1e84fdb8192a82cf733a3d350d86778608b7404836e1cd5c1232ef742.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>

  </head>
  <body class="td-page">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/ghidra_advisor/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">Ghidra Advisor for RISCV-64 Vector Extensions</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/ghidra_advisor/docs/"><span>Documents</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            <div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type="button" data-bs-toggle="collapse" data-bs-target="#td-section-nav" aria-controls="td-section-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="td-sidebar-nav collapse" id="td-section-nav">
    <ul class="td-sidebar-nav__section pe-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-ghidra_advisordocs-li">
  <a href="/ghidra_advisor/docs/" title="Ghidra Advisor Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-ghidra_advisordocs"><span class="">Documents</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-ghidra_advisordocsexamples-li">
  <a href="/ghidra_advisor/docs/examples/" title="Ghidra Advisor Examples" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-ghidra_advisordocsexamples"><span class="">Documents</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ghidra_advisordocsexampleswhisper_main_example-li">
  <a href="/ghidra_advisor/docs/examples/whisper_main_example/" title="Whisper.cpp Example" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-ghidra_advisordocsexampleswhisper_main_example"><span class="">Whisper Example</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-ghidra_advisordocsexamplesdpdk_example-li">
  <a href="/ghidra_advisor/docs/examples/dpdk_example/" title="DPDK Network Example" class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id="m-ghidra_advisordocsexamplesdpdk_example"><span class="td-sidebar-nav-active-item">DPDK Example</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-ghidra_advisordocsdeveloper_reference-li">
  <a href="/ghidra_advisor/docs/developer_reference/" title="Ghidra Advisor Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-ghidra_advisordocsdeveloper_reference"><span class="">Reference</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ghidra_advisordocsdeveloper_referencedependencies-li">
  <a href="/ghidra_advisor/docs/developer_reference/dependencies/" title="Advisor Dependencies" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-ghidra_advisordocsdeveloper_referencedependencies"><span class="">Dependencies</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ghidra_advisordocsdeveloper_referencepopulating_database-li">
  <a href="/ghidra_advisor/docs/developer_reference/populating_database/" title="Populating the Database" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-ghidra_advisordocsdeveloper_referencepopulating_database"><span class="">Database generation</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ghidra_advisordocsdeveloper_referencefeature_analysis-li">
  <a href="/ghidra_advisor/docs/developer_reference/feature_analysis/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-ghidra_advisordocsdeveloper_referencefeature_analysis"><span class="">Feature Analysis</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ghidra_advisordocsdeveloper_referencefaq-li">
  <a href="/ghidra_advisor/docs/developer_reference/faq/" title="Frequently Asked Questions" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-ghidra_advisordocsdeveloper_referencefaq"><span class="">FAQ</span></a>
</li>
  </ul>
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            <div class="td-page-meta ms-2 pb-1 pt-2 mb-0">
<a href="https://github.com/thixotropist/ghidra_advisor/tree/main/content/en/docs/Examples/Dpdk_example.md" class="td-page-meta--view td-page-meta__view" target="_blank" rel="noopener"><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
  <a href="https://github.com/thixotropist/ghidra_advisor/edit/main/content/en/docs/Examples/Dpdk_example.md" class="td-page-meta--edit td-page-meta__edit" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
  <a href="https://github.com/thixotropist/ghidra_advisor/new/main/content/en/docs/Examples?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" class="td-page-meta--child td-page-meta__child" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
  <a href="https://github.com/thixotropist/ghidra_advisor/issues/new?title=DPDK%20Network%20Example" class="td-page-meta--issue td-page-meta__issue" target="_blank" rel="noopener"><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a>
  <a id="print" href="/ghidra_advisor/docs/examples/_print/"><i class="fa-solid fa-print fa-fw"></i> Print entire section</a>

</div>

            <div class="td-toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#record-the-new-example">Record the new example</a></li>
    <li><a href="#feature-extraction">Feature extraction</a>
      <ul>
        <li><a href="#examination-of-test_1_ref">Examination of test_1_ref</a></li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
    
            
	
          </aside>
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="td-breadcrumbs">
  <ol class="breadcrumb">
  <li class="breadcrumb-item">
    <a href="/ghidra_advisor/docs/">Documents</a></li>
  <li class="breadcrumb-item">
    <a href="/ghidra_advisor/docs/examples/">Documents</a></li>
  <li class="breadcrumb-item active" aria-current="page">
    DPDK Example</li>
  </ol>
</nav>
            
<div class="td-content">
	<h1>DPDK Network Example</h1>
	
	<header class="article-meta">
		
  </header>
	<p>Are network appliances improved with autovectorization?  We can examine code examples taken from the
DPDK network project to find out.
We&rsquo;ll start with code that uses vector gather and slide operations in what <em>might</em> be a key datapath routine.
The binary <code>dpdk_l3fwd</code> is an example of a layer 3 forwarding engine.  It includes the function <code>rx_recv_pkts</code>,
which appears to be selected from the DPDK source file <code>drivers/net/iavf/iavf_rxtx.c</code>.</p>
<p>This function includes several vector stanzas that use <code>vrgather</code> and <code>vslide1down</code>.</p>
<p>We will make things a bit easier by including the preprocessed source file <code>drivers/net/iavf/iavf_rxtx.c</code>
in our custom dataset under <code>data/custom_testsuite/dpdk</code>.  This brings all of the relevant DPDK header files
inline.</p>
<p>The first vector stanza to examine is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>LAB_0053c12e             XREF[2]:     0053be34(j), 0053be42(j)  
</span></span><span style="display:flex;"><span>0053c12e 73 2e 20 c2     csrrs        t3,vlenb,zero
</span></span><span style="display:flex;"><span>0053c132 57 73 80 0d     vsetvli      t1,zero,e64,m1,ta,ma 
</span></span><span style="display:flex;"><span>0053c136 b3 0e c0 41     neg          t4,t3
</span></span><span style="display:flex;"><span>0053c13a 93 58 3e 00     srli         a7,t3,0x3
</span></span><span style="display:flex;"><span>0053c13e 3e 97           c.add        a4,a5
</span></span><span style="display:flex;"><span>0053c140 d7 a1 08 52     vid.v        v3
</span></span><span style="display:flex;"><span>0053c144 93 87 0e 04     addi         a5,t4,0x40
</span></span><span style="display:flex;"><span>0053c148 93 86 f8 ff     addi         a3,a7,-0x1
</span></span><span style="display:flex;"><span>0053c14c 33 67 f7 20     sh3add       a4,a4,a5
</span></span><span style="display:flex;"><span>0053c150 d7 c1 36 0e     vrsub.vx     v3,v3,a3
</span></span><span style="display:flex;"><span>0053c154 5a 97           c.add        a4,s6
</span></span><span style="display:flex;"><span>0053c156 3b 8f 1b 41     subw         t5,s7,a7
</span></span><span style="display:flex;"><span>0053c15a a2 86           c.mv         a3,s0
</span></span><span style="display:flex;"><span>0053c15c 81 47           c.li         a5,0x0
</span></span><span style="display:flex;"><span>LAB_0053c15e             XREF[1]:     0053c172(j)  
</span></span><span style="display:flex;"><span>0053c15e 07 71 87 02     vl1re64.v    v2,(a4)
</span></span><span style="display:flex;"><span>0053c162 bb 87 17 01     addw         a5,a5,a7
</span></span><span style="display:flex;"><span>0053c166 76 97           c.add        a4,t4
</span></span><span style="display:flex;"><span>0053c168 d7 80 21 32     vrgather.vv  v1,v2,v3
</span></span><span style="display:flex;"><span>0053c16c a7 80 86 02     vs1r.v       v1,(a3)
</span></span><span style="display:flex;"><span>0053c170 f2 96           c.add        a3,t3
</span></span><span style="display:flex;"><span>0053c172 e3 76 ff fe     bgeu         t5,a5,LAB_0053c15e
</span></span></code></pre></div><p>This sequence suggests a load/permute/store operation on 64 bit elements.  There are lots of complications:</p>
<ul>
<li>The function <code>rx_recv_pkts</code> has static inline attributes, so it has likely been merged with other functions</li>
<li>There are no obvious candidates for the gcc C source code that generates this <code>vrgather</code> pattern.</li>
<li>This may be an artifact of using snapshots of gcc and dpdk.</li>
<li>The <code>vs1r.v</code> instruction is a whole register store variant that ignores <code>vsetvli</code> settings.</li>
</ul>
<p>Analysis of this snippet is easier with emulation:</p>
<ul>
<li>The assembly fragment is copied into a new source file, <code>emulations/test_1.S</code></li>
<li>The assembly source is converted into a subroutine</li>
<li>Instrumentation is added to store intermediate values into global data variables.</li>
<li>A <code>main.c</code> driver routine is added, to provide input and output vectors and
instrumentation printouts.</li>
<li>A RISCV-64 executable is built</li>
<li>A RISCV-64 QEMU userspace emulator is built and configured</li>
<li>The RISCV-64 executable is run to see what permutations are generated</li>
<li>The RISCV-64 executable is run with alternate values for VLEN, to show that the results
are stable regardless of the vector hardware implementation.</li>
</ul>
<p>Process this Ghidra assembly fragment through the current Advisor:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-md" data-lang="md"><span style="display:flex;"><span>Signatures:
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">*</span> Element width is = 64 bits
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">*</span> Vector element index: vid.v
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">*</span> often used in generating a vector of offsets for indexing
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">*</span> Vector whole register load: vl1re64.v
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">*</span> Vector gather: vrgather.vv
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">*</span> Vector whole register(s) store: vs1r.v
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">*</span> Significant opcodes, in the order they appear:
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">*</span> vsetvli,vid.v,vrsub.vx,vl1re64.v,vrgather.vv,vs1r.v,bgeu
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">*</span> Significant opcodes, in alphanumeric order:
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">*</span> bgeu,vid.v,vl1re64.v,vrgather.vv,vrsub.vx,vs1r.v,vsetvli
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">*</span> At least one loop exists
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">## Similarity Analysis
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span>Compare the clipped example to the database of vectorized examples.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The best match is id=1689 [0.860]= vid.v,vle16.v,vrgather.vv,vrsub.vi,vse16.v,vsetivli
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The clip is similar to the reference example <span style="color:#4e9a06">`data/gcc_riscv_testsuite/rvv/autovec/vls-vlmax/perm-4_rv64gcv:permute_vnx2hi`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">### Reference C Source
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span>void permute_vnx2hi(vnx2hi values1, vnx2hi values2, vnx2hi *out)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  vnx2hi v = __builtin_shufflevector (values1, values2, (2) - 1 - (0), (2) - 2 - (0));
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-style:italic">*(vnx2hi *</span>) out = v;
</span></span><span style="display:flex;"><span>} <span style="color:#000;font-weight:bold">__attribute__</span>((noipa))
</span></span></code></pre></div><p>Gcc&rsquo;s <code>__builtin_shufflevector</code> with the given mask reverses the order of a vector of two 16 bit values.
The signature match of 0.86 suggests this is just a hint of what is going on here.</p>
<p>After rewriting the Ghidra sample as a riscv64 assembly routine, we get:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-as" data-lang="as"><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">section</span> <span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">test_1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">globl</span> <span style="color:#000">cntr</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">src_incr</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">dst_incr</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">src_start</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">dst_start</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">globl</span> <span style="color:#000">cnt_limit</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dst_incr</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">dword</span>  <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000">vl</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">dword</span>  <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000">src_incr</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">dword</span>  <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cntr</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">dword</span>  <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000">src_start</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">dword</span>  <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dst_start</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">dword</span>  <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cnt_limit</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">word</span>  <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">section</span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">text</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">test_1</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#4e9a06">&#34;ax&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#a40000">@</span><span style="color:#000">progbits</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">globl</span> <span style="color:#000">test_1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">type</span>  <span style="color:#000">test_1</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#a40000">@</span><span style="color:#204a87;font-weight:bold">function</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">test_1</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">csrrs</span>          <span style="color:#000">t3</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">vlenb</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">zero</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">lui</span>            <span style="color:#000">t6</span><span style="color:#ce5c00;font-weight:bold">,%</span><span style="color:#000">hi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dst_incr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">addi</span>           <span style="color:#000">t6</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">t6</span><span style="color:#ce5c00;font-weight:bold">,%</span><span style="color:#000">lo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dst_incr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sd</span>             <span style="color:#000">t3</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t6</span><span style="color:#000;font-weight:bold">)</span>                <span style="color:#a40000">#</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dst_incr</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli</span>        <span style="color:#000">t1</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">zero</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">e64</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">m1</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">ta</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">ma</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sd</span>             <span style="color:#000">t1</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t6</span><span style="color:#000;font-weight:bold">)</span>               <span style="color:#a40000">#</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">vl</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">neg</span>            <span style="color:#000">t4</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">t3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sd</span>             <span style="color:#000">t4</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t6</span><span style="color:#000;font-weight:bold">)</span>              <span style="color:#a40000">#</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">src_incr</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">srli</span>           <span style="color:#000">a7</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">t3</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0x3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sd</span>             <span style="color:#000">a7</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t6</span><span style="color:#000;font-weight:bold">)</span>              <span style="color:#a40000">#</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">cntr</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vid</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">v</span>          <span style="color:#000">v3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">addi</span>           <span style="color:#000">a5</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">t4</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0x40</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">addi</span>           <span style="color:#000">a3</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">a7</span><span style="color:#ce5c00;font-weight:bold">,-</span><span style="color:#0000cf;font-weight:bold">0x1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">add</span>            <span style="color:#000">a0</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">a5</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">a0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sd</span>             <span style="color:#000">a0</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t6</span><span style="color:#000;font-weight:bold">)</span>              <span style="color:#a40000">#</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">src_start</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vrsub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">vx</span>       <span style="color:#000">v3</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">v3</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">a3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">li</span>           <span style="color:#000">t5</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0x8</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">subw</span>           <span style="color:#000">t5</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">t5</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">a7</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sw</span>             <span style="color:#000">t5</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">48</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t6</span><span style="color:#000;font-weight:bold">)</span>              <span style="color:#a40000">#</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">cnt_limit</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vs1r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">v</span>         <span style="color:#000">v3</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">li</span>           <span style="color:#000">a5</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0x0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sd</span>             <span style="color:#000">a1</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">40</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t6</span><span style="color:#000;font-weight:bold">)</span>              <span style="color:#a40000">#</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dst_start</span>
</span></span><span style="display:flex;"><span><span style="color:#000">LAB_0053c15e</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vl1re64</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">v</span>      <span style="color:#000">v2</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">addw</span>           <span style="color:#000">a5</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">a5</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">a7</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span>          <span style="color:#000">a0</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">t4</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vrgather</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">vv</span>    <span style="color:#000">v1</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">v2</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">v3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vs1r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">v</span>         <span style="color:#000">v1</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">add</span>            <span style="color:#000">a1</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">a1</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">t3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bgeu</span>           <span style="color:#000">t5</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">a5</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">LAB_0053c15e</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ret</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">globl</span> <span style="color:#000">get_vlenb</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">type</span>  <span style="color:#000">get_vlanb</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#a40000">@</span><span style="color:#204a87;font-weight:bold">function</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">get_vlanb</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">csrrs</span>          <span style="color:#000">a0</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">vlenb</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">zero</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">srli</span>           <span style="color:#000">a2</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">a0</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0x3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ret</span>
</span></span></code></pre></div><p>The main routine to exercise this is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">extern</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">test_1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">extern</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">test_1_ref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">in</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">extern</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">cntr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">src_incr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dst_incr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">src_start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dst_start</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">extern</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">cnt_limit</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">in_vector</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">90</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">91</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">92</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">93</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">94</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">95</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">96</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">97</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">out_vector</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">shuffle_vector</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Initializing</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;in_vector_addr: %16p</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">in_vector</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;out_vector_addr: %16p</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">out_vector</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">test_1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_vector</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">out_vector</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">shuffle_vector</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cntr: %lld</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cntr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;vl: %lld</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;src_incr: 0x%llx</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">src_incr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;dst_incr: 0x%llx</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dst_incr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;src_start: %p</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">src_start</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;dst_start: %p</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">dst_start</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cnt_limit: 0x%lx</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cnt_limit</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;shuffle vector: %lld, %lld, %lld, %lld</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">shuffle_vector</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">shuffle_vector</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">shuffle_vector</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">shuffle_vector</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;out vector: %lld, %lld, %lld, %lld, &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">out_vector</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">out_vector</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">out_vector</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">out_vector</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%lld, %lld, %lld, %lld</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">out_vector</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">out_vector</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">out_vector</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">out_vector</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Assembly version Complete, starting reference version</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* Once the assembly mockup returns a good value, try a C equivalent
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    test_1_ref(in_vector, out_vector, 8);
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    printf(&#34;out vector: %lld, %lld, %lld, %lld, &#34;, out_vector[0], out_vector[1], out_vector[2], out_vector[3]);
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    printf(&#34;%lld, %lld, %lld, %lld\n&#34;, out_vector[4], out_vector[5], out_vector[6], out_vector[7]);
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The QEMU VLEN variable and microarchitecture extensions are configured on the command line.
The following requests the VLEN=128 minimum basic register size.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> <span style="color:#204a87">export</span> <span style="color:#000">QEMU_CPU</span><span style="color:#ce5c00;font-weight:bold">=</span>rv64,zba<span style="color:#ce5c00;font-weight:bold">=</span>true,zbb<span style="color:#ce5c00;font-weight:bold">=</span>true,v<span style="color:#ce5c00;font-weight:bold">=</span>true,vlen<span style="color:#ce5c00;font-weight:bold">=</span>128,vext_spec<span style="color:#ce5c00;font-weight:bold">=</span>v1.0,rvv_ta_all_1s<span style="color:#ce5c00;font-weight:bold">=</span>true,rvv_ma_all_1s<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span></code></pre></div><p>Build and run with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#000;font-style:italic">training_set$ bazel build --platforms=//platforms:riscv_gcc emulations:test_1
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Analyzed target //emulations:test_1 (0 packages loaded, 0 targets configured).
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Found 1 target...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Target //emulations:test_1 up-to-date:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  bazel-bin/emulations/test_1
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">training_set$ qemu-riscv64-static -L /opt/riscvx/sysroot -E LD_LIBRARY_PATH=/opt/riscvx/sysroot/riscv64-unknown-linux-gnu/lib/ bazel-bin/emulations/test_1
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Initializing
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">in_vector_addr:   0x2aaaab2aaab0
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">out_vector_addr:   0x2aaaab2aaaf0
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">cntr: 2
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">vl: 2
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">src_incr: 0xfffffffffffffff0
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">dst_incr: 0x10
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">src_start: 0x2aaaab2aaae0
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">dst_start: 0x2aaaab2aaaf0
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">cnt_limit: 0x6
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">shuffle vector: 1, 0, 0, 0
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">out vector: 97, 96, 95, 94, 93, 92, 91, 90
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Complete!
</span></span></span></code></pre></div><p>Repeat with VLEN=256 and the same executable binary, to see if the results are stable:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> <span style="color:#204a87">export</span> <span style="color:#000">QEMU_CPU</span><span style="color:#ce5c00;font-weight:bold">=</span>rv64,zba<span style="color:#ce5c00;font-weight:bold">=</span>true,zbb<span style="color:#ce5c00;font-weight:bold">=</span>true,v<span style="color:#ce5c00;font-weight:bold">=</span>true,vlen<span style="color:#ce5c00;font-weight:bold">=</span>256,vext_spec<span style="color:#ce5c00;font-weight:bold">=</span>v1.0,rvv_ta_all_1s<span style="color:#ce5c00;font-weight:bold">=</span>true,rvv_ma_all_1s<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">training_set$ qemu-riscv64-static -L /opt/riscvx/sysroot -E LD_LIBRARY_PATH=/opt/riscvx/sysroot/riscv64-unknown-linux-gnu/lib/ bazel-bin/emulations/test_1
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Initializing
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">in_vector_addr:   0x2aaaab2aaab0
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">out_vector_addr:   0x2aaaab2aaaf0
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">cntr: 4
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">vl: 4
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">src_incr: 0xffffffffffffffe0
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">dst_incr: 0x20
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">src_start: 0x2aaaab2aaad0
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">dst_start: 0x2aaaab2aaaf0
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">cnt_limit: 0x4
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">shuffle vector: 3, 2, 1, 0
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">out vector: 97, 96, 95, 94, 93, 92, 91, 90
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Complete!
</span></span></span></code></pre></div><p>So now the permutation is clear - this snippet copies a vector of 64 bit values - likely pointers - from one location to another <em>in the reverse order</em>.
The source pointer advances backwards, starting <code>vl</code> elements before the end, while the
destination pointer advances forwards, starting at the first element.  The reverse-copy
operation is stable with VLEN of 128 or 256 bits.</p>
<p>Next we can add <code>test_1_ref.c</code>, a C routine which should compile to something much closer to the
sample binary:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">test_1_ref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">in</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">upper_index</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">out</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">in</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">upper_index</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="record-the-new-example">Record the new example</h2>
<p>We want to add <code>test_1_ref</code> to the training set database, so copy it into <code>custom_testsuite/structs</code>, update the
BUILD file there, then rerun the analysis:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#000;font-style:italic">./generator.py 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./ingest.py 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./sample_analytics.py 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./advisor.py data_test/advisor_tests/gather2.ghidra
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">The best match is id=1864 [0.926]= bgeu,bltu,bne,vid.v,vl1re64.v,vrgather.vv,vrsub.vx,vs1r.v,vsetvli
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">The clip is similar to the reference example `data/custom_testsuite/structs/test_1_ref_rv64gcv:test_1_ref`
</span></span></span></code></pre></div><p>The extra branch instructions clutter the signature match result somewhat.</p>
<h2 id="feature-extraction">Feature extraction</h2>
<p>What generalized features does this example provide?</p>
<ol>
<li>There is a single loop</li>
<li>The loop includes one vector load, one vector store, and one vector gather
operation.</li>
<li>The loop exit condition depends on a scalar counter advancing to equal or
exceed a fixed limit value, without a dependency on vector element values.</li>
<li>Source and destination pointers increment with different values</li>
<li>The loop setup identifies the SEW as 64 bits.  This is unchanged throughout
the sample code.  This implies that this <code>vs1r.v</code> instruction is equivalent to
a <code>vse64.v</code> instruction.</li>
<li>The <code>bgeu</code> instruction terminating the loop could be encoded as <code>bleu</code> with
reversed operands.  More generally, the loop termination could have been
implemented in several different ways.</li>
</ol>
<p>Register assignments appear to be:</p>
<table>
  <thead>
      <tr>
          <th>Assignment</th>
          <th>Register</th>
          <th>Initializations</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Source address</td>
          <td>a4</td>
          <td></td>
      </tr>
      <tr>
          <td>Source address increment</td>
          <td>t4</td>
          <td>= (-vlenb)</td>
      </tr>
      <tr>
          <td>Destination address</td>
          <td>a3</td>
          <td></td>
      </tr>
      <tr>
          <td>Destination address increment</td>
          <td>t3</td>
          <td>= vlenb</td>
      </tr>
      <tr>
          <td>Loop counter</td>
          <td>a5</td>
          <td>=0</td>
      </tr>
      <tr>
          <td>Loop counter increment</td>
          <td>a7</td>
          <td>vlenb&raquo;3</td>
      </tr>
      <tr>
          <td>Loop counter limit</td>
          <td>t5</td>
          <td></td>
      </tr>
      <tr>
          <td>Source vector register</td>
          <td>v2</td>
          <td></td>
      </tr>
      <tr>
          <td>Destination vector register</td>
          <td>v1</td>
          <td></td>
      </tr>
      <tr>
          <td>Gather index vector register</td>
          <td>v3</td>
          <td>depends on vlenb</td>
      </tr>
  </tbody>
</table>
<p>The vector gather index register v3 depends on vl, the number
of 64 bit elements that fit within a vector register.</p>
<ul>
<li>if vlen = 128 - or vlenb = 16 - then v3 = (1,0)</li>
<li>if vlen = 256 - or vlenb = 32 - then v3 = (3,2,1,0)</li>
</ul>
<p>It is not at all clear whether the compiler knows the size of the
source vector, or whether the code works as intended when
the source vector size is odd or smaller than the size of a vector
register.</p>
<p>We can resolve that by looking at Ghidra&rsquo;s decompiler window.
The vector instruction stanza actually begins earlier, executing the vector instructions
only after a test of vlenb.</p>
<h3 id="examination-of-test_1_ref">Examination of test_1_ref</h3>
<p>GCC 15 compiles <code>test_1_ref.c</code> into something more complex than the assembly code stanza
we analyzed.  The single-line loop becomes three loops - a scalar loop to handle
relatively small vector sizes, then a vector loop to handle an integer number of VLEN strips, finally a second
scalar loop to handle any remaining elements.  For the code stanza passed in for analysis the
input and output vectors appear to have a fixed size known to the compiler - 64 bytes.  This implies
no scalar loops needed for VLEN=128 bits or VLEN=256 bits.  The code stanza would generate
a buffer overflow error for VLEN&gt;512 bits.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">test_1_ref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ulonglong</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">in</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">ulonglong</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">out</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">ulong</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ulonglong</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pIn</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ulonglong</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">puVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">lVar2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ulonglong</span> <span style="color:#000">uVar3</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ulong</span> <span style="color:#000">uVar4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ulong</span> <span style="color:#000">uVar5</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">iVar6</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar7</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar8</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ulong</span> <span style="color:#000">in_vlenb</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ulonglong</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pOut</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#000">gp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">__global_pointer</span><span style="color:#a40000">$</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">uVar5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ulong</span><span style="color:#000;font-weight:bold">)((</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(((</span><span style="color:#000">uVar5</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0xd</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">uVar5</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ulong</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)((</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">in_vlenb</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)))</span> <span style="color:#ce5c00;font-weight:bold">||</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">((</span><span style="color:#000">lVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">uVar5</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">in</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar2</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0xffffffff</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">out</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0xffffffff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">(</span><span style="color:#000">out</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">in</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">lVar2</span><span style="color:#000;font-weight:bold">))))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">pIn</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">in</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">uVar5</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">pOut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">out</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">uVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pIn</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">puVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pOut</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">pIn</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pIn</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pOut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">uVar3</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">pOut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">puVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">puVar1</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">out</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0xffffffff</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli_e64m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar8</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vid_v</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar8</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vrsub_vx</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar8</span><span style="color:#000;font-weight:bold">,(</span><span style="color:#000">in_vlenb</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">lVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lVar2</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">in_vlenb</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">in</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">iVar6</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">in_vlenb</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">uVar4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">pOut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">out</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">auVar7</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vl1re64_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">uVar4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ulong</span><span style="color:#000;font-weight:bold">)((</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">uVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">iVar6</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">lVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lVar2</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">in_vlenb</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">auVar7</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vrgather_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar7</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar8</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">vs1r_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar7</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">pOut</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">pOut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ulonglong</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)((</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">pOut</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">in_vlenb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">uVar4</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ulong</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)((</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">iVar6</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">uVar4</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">pOut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">in</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">uVar5</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">uVar4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">pIn</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">out</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">uVar4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">uVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pOut</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">uVar4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ulong</span><span style="color:#000;font-weight:bold">)((</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">uVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">pOut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pOut</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pIn</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">uVar3</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">pIn</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pIn</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">uVar4</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The scalar loop consists of about 22 bytes, or 7 instructions.  The full vector function takes up 180 bytes.
There is little reason to believe that vectorization actually improves this code, especially for vector
harts holding only two 64 bit objects per vector register.</p>
<h3 id="summary">Summary</h3>
<p>There is no visible reason to enable full autovectorization for datapath network routing code like DPDK.
It <em>might</em> make sense to vectorize lockable critical regions or specific critical path code.
Vector replacement of utility functions like memcpy or strncmp would still make sense.
If someone created an AI-adaptive network appliance the math inference engine portions would likely be improved
with vectorization.</p>

	<div class="td-page-meta__lastmod">
  Last modified November 2, 2024: <a href="https://github.com/thixotropist/ghidra_advisor/commit/7feaa1369388930d1af2a9acd93f9091d2ccf7e7">Add documentation content (7feaa13)</a>
</div>

</div>


          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        
      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2024&ndash;2024
    <span class="td-footer__authors">Thixotropist | <a href="https://creativecommons.org/licenses/by/4.0">CC BY 4.0</a> |</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span><span class="ms-2"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">Privacy Policy</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/ghidra_advisor/js/main.min.8a3d965bc9a92ad6123f0652ee76ba34b339af74ad47af20e7c54a84385cd39a.js" integrity="sha256-ij2WW8mpKtYSPwZS7na6NLM5r3StR68g58VKhDhc05o=" crossorigin="anonymous"></script>
<script defer src="/ghidra_advisor/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js" integrity="sha256-c0eKfUgHaYrtfjVesj&#43;YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin="anonymous"></script>
<script src='/ghidra_advisor/js/tabpane-persist.js'></script>

  </body>
</html>